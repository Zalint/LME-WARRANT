<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>LME Multi-Contract Calculator - Enhanced</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            color: #333;
        }

        .navbar {
            background: rgba(0,0,0,0.2);
            backdrop-filter: blur(10px);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .navbar .logo {
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
            text-decoration: none;
        }

        .back-btn {
            color: white;
            text-decoration: none;
            padding: 0.5rem 1rem;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            transition: all 0.3s;
        }

        .back-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            min-height: calc(100vh - 80px);
            display: grid;
            grid-template-columns: 450px 1fr;
            box-shadow: 0 0 50px rgba(0,0,0,0.3);
        }

        .sidebar {
            background: linear-gradient(180deg, #f8fafc 0%, #e2e8f0 100%);
            padding: 2rem;
            border-right: 1px solid #e2e8f0;
            overflow-y: auto;
            max-height: calc(100vh - 80px);
        }

        .main-content {
            padding: 2rem;
            overflow-y: auto;
            max-height: calc(100vh - 80px);
        }

        .section {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0;
        }

        .section h3 {
            color: #1e40af;
            margin-bottom: 1rem;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            border-bottom: 2px solid #1e40af;
            padding-bottom: 0.5rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.4rem;
            color: #374151;
            font-size: 0.9rem;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 0.7rem;
            border: 2px solid #d1d5db;
            border-radius: 8px;
            font-size: 0.95rem;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #1e40af;
            box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .metal-selector {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none !important;
            font-weight: 600;
        }

        .metal-selector option {
            background: white;
            color: #1f2937;
            font-weight: 600;
        }

        .metal-info {
            background: #ecfdf5;
            border: 1px solid #10b981;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 0.5rem;
            font-size: 0.85rem;
        }

        .warrant-preview {
            background: #f0f9ff;
            border: 2px solid #3b82f6;
            border-radius: 8px;
            padding: 1rem;
            margin: 1rem 0;
            max-height: 200px;
            overflow-y: auto;
        }

        .warrant-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 0.5rem;
            font-size: 0.8rem;
            font-family: monospace;
        }

        .warrant-item {
            background: white;
            padding: 0.4rem;
            border-radius: 4px;
            text-align: center;
            border: 1px solid #3b82f6;
        }

        .warrant-summary {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 2px solid #3b82f6;
            font-weight: bold;
            font-size: 0.9rem;
            color: #1e40af;
        }

        .btn {
            width: 100%;
            padding: 0.8rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 0.5rem;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .btn-generate {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            color: white;
            padding: 0.6rem;
            font-size: 0.9rem;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .result-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0;
        }

        .result-card h3 {
            margin-bottom: 1rem;
            font-size: 1.2rem;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin: 1rem 0;
        }

        .summary-item {
            text-align: center;
            padding: 1.5rem;
            border-radius: 8px;
        }

        .summary-item.profit {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            border: 1px solid #10b981;
        }

        .summary-item.loss {
            background: linear-gradient(135deg, #fef2f2 0%, #fecaca 100%);
            border: 1px solid #ef4444;
        }

        .summary-value {
            font-size: 1.8rem;
            font-weight: bold;
            margin-top: 0.5rem;
        }

        .summary-value.positive { color: #10b981; }
        .summary-value.negative { color: #ef4444; }

        .formula {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-left: 4px solid #1e40af;
            padding: 1rem;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            margin: 1rem 0;
            line-height: 1.6;
        }

        .match-indicator {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            border: 2px solid #10b981;
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
            font-weight: bold;
            color: #059669;
            font-size: 1.1rem;
            margin: 1rem 0;
        }

        .loading-spinner {
            display: none;
            text-align: center;
            padding: 3rem;
            color: #6b7280;
        }

        .spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #1e40af;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        @media (max-width: 1200px) {
            .container {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                border-right: none;
                border-bottom: 1px solid #e2e8f0;
            }
        }

        @media (max-width: 768px) {
            .navbar {
                flex-direction: column;
                gap: 1rem;
                padding: 1rem;
                position: sticky;
                top: 0;
                z-index: 1000;
            }

            .navbar .logo {
                font-size: 1.2rem;
            }

            .container {
                margin: 0;
                padding: 1rem;
                padding-top: 80px; /* Account for sticky navbar */
            }

            .sidebar, .main-content {
                padding: 1rem;
            }

            .section {
                padding: 1.25rem;
                margin-bottom: 1.25rem;
                box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            }

            .section h3 {
                font-size: 1.2rem;
                margin-bottom: 1rem;
            }

            .form-group {
                margin-bottom: 1.25rem;
            }

            .form-row {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            label {
                font-weight: 600;
                margin-bottom: 0.5rem;
                display: block;
            }

            input, select, .btn {
                font-size: 16px; /* Prevents zoom on iOS */
                padding: 1rem;
                border-radius: 10px;
            }

            input, select {
                border: 2px solid #cbd5e1;
                transition: border-color 0.3s;
            }

            input:focus, select:focus {
                border-color: #3b82f6;
                outline: none;
                box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            }

            .btn {
                min-height: 48px; /* iOS touch target size */
                font-weight: 600;
                letter-spacing: 0.5px;
            }

            .btn-primary, .btn-secondary {
                position: sticky;
                bottom: 1rem;
                z-index: 100;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            }

            .result-card {
                padding: 1.25rem;
                margin-bottom: 1.25rem;
                box-shadow: 0 2px 12px rgba(0,0,0,0.1);
            }

            .result-card h3 {
                font-size: 1.2rem;
                margin-bottom: 1rem;
            }

            .formula {
                font-size: 0.9rem;
                line-height: 1.6;
                padding: 1rem;
            }

            .warrant-grid {
                grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
                font-size: 0.8rem;
                gap: 0.5rem;
            }

            .warrant-preview {
                max-height: 200px;
                overflow-y: auto;
                -webkit-overflow-scrolling: touch;
            }

            small {
                display: block;
                margin-top: 0.5rem;
                line-height: 1.4;
            }
        }

        @media (max-width: 480px) {
            body {
                font-size: 14px;
            }

            .navbar .logo {
                font-size: 1rem;
            }

            .back-btn {
                padding: 0.4rem 0.8rem;
                font-size: 0.9rem;
            }

            .container {
                padding: 0.5rem;
            }

            .section {
                padding: 0.75rem;
                margin-bottom: 0.75rem;
            }

            .section h3 {
                font-size: 1rem;
                margin-bottom: 0.75rem;
            }

            label {
                font-size: 0.9rem;
            }

            input, select {
                padding: 0.6rem;
            }

            .btn {
                padding: 0.75rem;
                font-size: 0.95rem;
            }

            .result-card {
                padding: 0.75rem;
            }

            .result-card h3 {
                font-size: 1rem;
            }

            .summary-grid {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }

            .formula {
                font-size: 0.8rem;
                padding: 0.75rem;
            }

            small {
                font-size: 0.75rem;
            }

            .warrant-grid {
                grid-template-columns: repeat(auto-fill, minmax(50px, 1fr));
                gap: 0.3rem;
                font-size: 0.7rem;
            }

            .warrant-item {
                padding: 0.3rem;
            }

            .warrant-preview {
                max-height: 120px;
                padding: 0.75rem;
            }
        }

        /* iOS Safari specific fixes */
        @supports (-webkit-touch-callout: none) {
            input, select, textarea {
                -webkit-appearance: none;
                appearance: none;
                border-radius: 8px;
            }
            
            .btn {
                -webkit-tap-highlight-color: rgba(0,0,0,0.1);
            }
        }
    </style>
</head>
<body>
    <script>
        // Authentication check
        if (sessionStorage.getItem('lme_auth_token') !== 'authenticated') {
            window.location.href = 'login.html';
        }
    </script>

    <div class="navbar">
        <a href="index.html" class="logo">üî¢ LME Calculator Suite</a>
        <a href="index.html" class="back-btn">‚Üê Back to Home</a>
    </div>

    <div class="container">
        <div class="sidebar">
            <div class="section">
                <h3>üè≠ Metal Selection</h3>
                <div class="form-group">
                    <label>Base Metal</label>
                    <select id="metalSelector" class="metal-selector" onchange="updateMetalPrices()">
                        <option value="CU">Copper (Cu) - $9,779/tonne</option>
                        <option value="AL">Aluminium (Al) - $2,697/tonne</option>
                        <option value="NI">Nickel (Ni) - $15,185/tonne</option>
                        <option value="ZN">Zinc (Zn) - $2,992/tonne</option>
                        <option value="PB">Lead (Pb) - $2,013/tonne</option>
                        <option value="SN">Tin (Sn) - $35,410/tonne</option>
                    </select>
                    <div class="metal-info" id="metalInfo">
                        <strong>Copper (Cu)</strong><br>
                        Current Price: $9,779/tonne<br>
                        Standard Lot: 25 tonnes<br>
                        Contract Currency: USD
                    </div>
                </div>
            </div>

            <div class="section">
                <h3>üìã Position Size</h3>
                <div class="form-group">
                    <label>Number of Futures Contracts</label>
                    <input type="number" inputmode="numeric" id="numContracts" value="5" step="1" min="1" max="1000" onchange="updateTotalFutures()">
                    <small id="lotSizeInfo" style="color: #6b7280;">Each contract = 25 MT standard lot</small>
                </div>
                <div class="form-group">
                    <label>Total Futures Size (MT)</label>
                    <input type="number" inputmode="numeric" id="totalFutures" value="125" readonly style="background: #f3f4f6; font-weight: bold;">
                </div>
            </div>

            <div class="section">
                <h3>üì¶ Warrant Configuration</h3>
                <div class="form-group">
                    <label>Warrant Weight Range (MT per warrant)</label>
                    <div class="form-row">
                        <div>
                            <input type="number" inputmode="decimal" id="minWeight" value="24.5" step="0.1" min="20">
                            <small style="color: #6b7280;">Minimum</small>
                        </div>
                        <div>
                            <input type="number" inputmode="decimal" id="maxWeight" value="25.5" step="0.1" max="30">
                            <small style="color: #6b7280;">Maximum</small>
                        </div>
                    </div>
                </div>
                <button class="btn btn-generate" onclick="generateWarrants()">
                    üîÑ Generate Random Warrants
                </button>
                <div id="warrantsPreview" style="display:none;" class="warrant-preview">
                    <h4 style="color: #1e40af; margin-bottom: 0.5rem;">Generated Warrants:</h4>
                    <div id="warrantsList" class="warrant-grid"></div>
                    <div class="warrant-summary">
                        <div>Total Warrants: <span id="warrantCount">0</span></div>
                        <div>Total Physical Weight: <span id="totalPhysicalWeight">0</span> MT</div>
                        <div>Weight Differential: <span id="weightDiff">0</span> MT</div>
                    </div>
                </div>
            </div>

            <div class="section">
                <h3>üìÖ Pickup Leg</h3>
                <div class="form-group">
                    <label>Future Purchase Date</label>
                    <input type="date" id="pickupPurchaseDate" value="2025-10-01">
                </div>
                <div class="form-group">
                    <label>Future Expiry/Pickup Date</label>
                    <input type="date" id="pickupDate" value="2025-10-16">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Future Price (P<sub>Fi</sub>)</label>
                        <input type="text" inputmode="decimal" id="pFi" value="9750.00" pattern="[0-9.,]*">
                    </div>
                    <div class="form-group">
                        <label>Warrant Price (P<sub>wi</sub>)</label>
                        <input type="text" inputmode="decimal" id="pWi" value="9779.00" pattern="[0-9.,]*">
                    </div>
                </div>
            </div>

            <div class="section">
                <h3>üìÖ Delivery Leg</h3>
                <div class="form-group">
                    <label>Future Purchase Date</label>
                    <input type="date" id="deliveryPurchaseDate" value="2025-10-15">
                </div>
                <div class="form-group">
                    <label>Future Expiry/Delivery Date</label>
                    <input type="date" id="deliveryDate" value="2025-11-14">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Future Price (P<sub>Fj</sub>)</label>
                        <input type="text" inputmode="decimal" id="pFj" value="9820.00" pattern="[0-9.,]*">
                    </div>
                    <div class="form-group">
                        <label>Warrant Price (P<sub>wj</sub>)</label>
                        <input type="text" inputmode="decimal" id="pWj" value="9850.00" pattern="[0-9.,]*">
                    </div>
                </div>
            </div>

            <div class="section">
                <h3>üí∞ Carrying Costs (Information Only)</h3>
                <div class="form-group">
                    <label>Rent Rate (USD/MT/day)</label>
                    <input type="text" inputmode="decimal" id="rentRate" value="0.55" pattern="[0-9.,]*">
                    <small style="color: #6b7280;">Default: 0.55 per MT per day (all days)</small>
                </div>
                <div class="form-group">
                    <label>Rent Day Count Override (optional)</label>
                    <input type="text" inputmode="numeric" id="rentDayCountOverride" value="" pattern="[0-9]*" placeholder="Leave empty for auto">
                    <small style="color: #6b7280;">Override day count for rent calculation only</small>
                </div>
                <div class="form-group">
                    <label>SOFR Rate (%)</label>
                    <input type="text" inputmode="decimal" id="sofrRate" value="4.50" pattern="[0-9.,]*">
                    <small style="color: #6b7280;">For financing cost calculation (ACT/360)</small>
                </div>
                <div class="form-group">
                    <label>SOFR Day Count Override (optional)</label>
                    <input type="text" inputmode="numeric" id="dayCountOverride" value="" pattern="[0-9]*" placeholder="Leave empty for auto">
                    <small style="color: #6b7280;">Override day count for SOFR financing only</small>
                </div>
                <div class="form-group" style="background: #fef3c7; padding: 0.8rem; border-radius: 8px; margin-top: 1rem;">
                    <strong style="color: #92400e; display: block; margin-bottom: 0.5rem;">Fixed Fees per Lot (Editable):</strong>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 0.5rem;">
                        <div>
                            <label style="font-size: 0.75rem; color: #78350f; display: block; margin-bottom: 0.2rem;">Clearing ($)</label>
                            <input type="number" inputmode="decimal" id="feesClearing" value="2.40" step="0.01" min="0" style="font-size: 0.85rem; padding: 0.4rem;">
                        </div>
                        <div>
                            <label style="font-size: 0.75rem; color: #78350f; display: block; margin-bottom: 0.2rem;">LME Fees ($)</label>
                            <input type="number" inputmode="decimal" id="feesLME" value="1.84" step="0.01" min="0" style="font-size: 0.85rem; padding: 0.4rem;">
                        </div>
                    </div>
                    <div style="margin-bottom: 0.5rem;">
                        <label style="font-size: 0.75rem; color: #78350f; display: block; margin-bottom: 0.2rem;">Macquarie ($)</label>
                        <input type="number" inputmode="decimal" id="feesMacquarie" value="0.55" step="0.01" min="0" style="font-size: 0.85rem; padding: 0.4rem; width: calc(50% - 0.25rem);">
                    </div>
                    <div style="background: #fbbf24; padding: 0.4rem; border-radius: 4px; text-align: center;">
                        <strong style="color: #78350f;">Total: $<span id="feesTotal">4.79</span> per lot</strong>
                    </div>
                </div>
            </div>

            <button class="btn btn-primary" onclick="calculate()">
                üìä Calculate P&L Reconciliation
            </button>
            <button class="btn btn-secondary" onclick="exportToExcel()">
                üìã Export to Excel
            </button>
            <button class="btn" onclick="manualSaveData()" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; margin-top: 0.5rem;">
                üíæ Save Data
            </button>
            <button class="btn" onclick="clearSavedData()" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; margin-top: 0.5rem;">
                üóëÔ∏è Clear Saved Data
            </button>
        </div>

        <div class="main-content" id="resultsPanel">
            <div class="loading-spinner" id="loadingSpinner">
                <div class="spinner"></div>
                <h3>Generate warrants and click Calculate</h3>
                <p>Your multi-contract P&L reconciliation will appear here with detailed portfolio analysis</p>
            </div>
        </div>
    </div>

    <script>
        let warrants = [];

        // Metal price data
        const METAL_PRICES = {
            AL: { name: 'Aluminium', price: 2697.25, symbol: 'Al', lotSize: 25 },
            CU: { name: 'Copper', price: 9779.00, symbol: 'Cu', lotSize: 25 },
            PB: { name: 'Lead', price: 2013.00, symbol: 'Pb', lotSize: 25 },
            NI: { name: 'Nickel', price: 15185.00, symbol: 'Ni', lotSize: 6 },
            ZN: { name: 'Zinc', price: 2992.00, symbol: 'Zn', lotSize: 25 },
            SN: { name: 'Tin', price: 35410.00, symbol: 'Sn', lotSize: 5 }
        };

        function updateTotalFutures() {
            const num = parseInt(document.getElementById('numContracts').value) || 1;
            const selectedMetal = document.getElementById('metalSelector').value;
            const metalData = METAL_PRICES[selectedMetal];
            document.getElementById('totalFutures').value = (num * metalData.lotSize).toFixed(0);
        }

        function updateMetalPrices() {
            const selectedMetal = document.getElementById('metalSelector').value;
            const metalData = METAL_PRICES[selectedMetal];
            
            // Update lot size field automatically
            document.getElementById('lotSize').value = metalData.lotSize;
            
            // Update total futures based on new lot size
            updateTotalFutures();
            
            // Update lot size info text
            document.getElementById('lotSizeInfo').textContent = `Each contract = ${metalData.lotSize} MT standard lot`;
            
            // Update metal info
            document.getElementById('metalInfo').innerHTML = `
                <strong>${metalData.name} (${metalData.symbol})</strong><br>
                Current Price: $${metalData.price.toLocaleString()}/tonne<br>
                Standard Lot: ${metalData.lotSize} tonnes<br>
                Contract Currency: USD
            `;

            // Generate realistic price variations
            const basePrice = metalData.price;
            const variation = basePrice * 0.02; // 2% variation
            
            // Update prices
            const prices = {
                pFi: (basePrice - Math.random() * variation).toFixed(2),
                pWi: (basePrice + Math.random() * variation * 0.5).toFixed(2),
                pFj: (basePrice + Math.random() * variation).toFixed(2),
                pWj: (basePrice + Math.random() * variation * 1.2).toFixed(2)
            };

            document.getElementById('pFi').value = prices.pFi;
            document.getElementById('pWi').value = prices.pWi;
            document.getElementById('pFj').value = prices.pFj;
            document.getElementById('pWj').value = prices.pWj;

            // Re-generate warrants if they exist
            if (warrants.length > 0) {
                generateWarrants();
            }
        }

        function generateWarrants() {
            const numContracts = parseInt(document.getElementById('numContracts').value) || 1;
            const minWeight = parseFloat(document.getElementById('minWeight').value);
            const maxWeight = parseFloat(document.getElementById('maxWeight').value);

            if (minWeight >= maxWeight) {
                alert('Minimum weight must be less than maximum weight');
                return;
            }

            warrants = [];
            let totalWeight = 0;

            for (let i = 0; i < numContracts; i++) {
                const weight = minWeight + Math.random() * (maxWeight - minWeight);
                const rounded = Math.round(weight * 1000) / 1000;
                warrants.push(rounded);
                totalWeight += rounded;
            }

            // Display warrants
            const list = document.getElementById('warrantsList');
            list.innerHTML = warrants.map((w, i) => 
                `<div class="warrant-item">#${i+1}<br>${w.toFixed(3)}</div>`
            ).join('');

            const selectedMetal = document.getElementById('metalSelector').value;
            const metalData = METAL_PRICES[selectedMetal];
            const totalFutures = numContracts * metalData.lotSize;
            document.getElementById('warrantCount').textContent = numContracts;
            document.getElementById('totalPhysicalWeight').textContent = totalWeight.toFixed(3);
            document.getElementById('weightDiff').textContent = (totalWeight - totalFutures).toFixed(3);
            document.getElementById('warrantsPreview').style.display = 'block';
        }

        function calculate() {
            if (warrants.length === 0) {
                alert('Please generate warrants first!');
                return;
            }

            // Show loading (recreate if it doesn't exist)
            const resultsPanel = document.getElementById('resultsPanel');
            const loadingSpinner = document.getElementById('loadingSpinner');
            
            if (!loadingSpinner) {
                resultsPanel.innerHTML = `
                    <div class="loading-spinner" id="loadingSpinner" style="display: block;">
                        <div class="spinner"></div>
                        <h3>Calculating...</h3>
                        <p>Processing your portfolio P&L reconciliation</p>
                    </div>
                `;
            } else {
                loadingSpinner.style.display = 'block';
            }
            
            setTimeout(() => {
                const selectedMetal = document.getElementById('metalSelector').value;
                const metalData = METAL_PRICES[selectedMetal];
                
                const numContracts = warrants.length;
                const W = warrants.reduce((sum, w) => sum + w, 0);
                const U = numContracts * metalData.lotSize;
                // Normalize and parse inputs (accept both comma and dot)
                const pFi = parseFloat(document.getElementById('pFi').value.replace(/,/g, '.'));
                const pWi = parseFloat(document.getElementById('pWi').value.replace(/,/g, '.'));
                const pFj = parseFloat(document.getElementById('pFj').value.replace(/,/g, '.'));
                const pWj = parseFloat(document.getElementById('pWj').value.replace(/,/g, '.'));

                // Get dates for carrying cost calculation
                const pickupDate = new Date(document.getElementById('pickupDate').value);
                const deliveryDate = new Date(document.getElementById('deliveryDate').value);
                
                // Day count: use override if provided, otherwise calculate from dates
                const autoDayCount = Math.max(0, Math.floor((deliveryDate - pickupDate) / (1000 * 60 * 60 * 24)));
                
                // Separate overrides for Rent and SOFR
                const rentDayCountOverride = parseInt(document.getElementById('rentDayCountOverride').value);
                const rentDayCount = (rentDayCountOverride && rentDayCountOverride > 0) ? rentDayCountOverride : autoDayCount;
                
                const sofrDayCountOverride = parseInt(document.getElementById('dayCountOverride').value);
                const sofrDayCount = (sofrDayCountOverride && sofrDayCountOverride > 0) ? sofrDayCountOverride : autoDayCount;
                
                // Carrying costs (all negative as they are costs)
                const rentRate = parseFloat(document.getElementById('rentRate').value.replace(/,/g, '.'));
                const sofrRate = parseFloat(document.getElementById('sofrRate').value.replace(/,/g, '.'));
                const numLots = W / metalData.lotSize;
                
                // Rent: rate * weight * days (all days including weekends)
                const rentCost = -Math.abs(rentRate * W * rentDayCount);
                
                // Fixed fees: per lot (editable)
                const feesClearing = parseFloat(document.getElementById('feesClearing').value.replace(/,/g, '.')) || 2.40;
                const feesLME = parseFloat(document.getElementById('feesLME').value.replace(/,/g, '.')) || 1.84;
                const feesMacquarie = parseFloat(document.getElementById('feesMacquarie').value.replace(/,/g, '.')) || 0.55;
                const fixedFeesPerLot = feesClearing + feesLME + feesMacquarie;
                const totalFixedFees = -Math.abs(fixedFeesPerLot * numLots);
                
                // Financing: SOFR rate % / 360 * daycount * warrant price * lotSize * notional
                const financingCost = -Math.abs((sofrRate / 100 / 360) * sofrDayCount * pWi * metalData.lotSize * numLots);
                
                const totalCarryingCosts = rentCost + totalFixedFees + financingCost;

                // Calculate P&L
                const weightDiff = (pWj - pWi) * (W - U);
                const spreadComponent = (pFj - pFi) * U;
                const traderTotal = weightDiff + spreadComponent;

                const pickupFuture = U * (pWi - pFi);
                const deliveryFuture = -U * (pWj - pFj);
                const deliveryWarrant = W * (pWj - pWi);
                const murexTotal = pickupFuture + deliveryFuture + deliveryWarrant;

                const fmt = (n) => n.toFixed(3);
                const curr = (n) => n.toFixed(2);

                const html = `
                    <div class="result-card" style="border-left: 6px solid #10b981;">
                        <h3>‚úÖ Portfolio P&L Summary - ${numContracts} Contracts (${metalData.name})</h3>
                        
                        <div style="background: #f0f9ff; padding: 1rem; border-radius: 8px; margin: 1rem 0;">
                            <strong>Position Overview:</strong><br>
                            Metal: ${metalData.name} (${metalData.symbol})<br>
                            Contracts: ${numContracts} √ó ${metalData.lotSize} MT = ${fmt(U)} MT futures<br>
                            Physical: ${numContracts} warrants = ${fmt(W)} MT total<br>
                            Weight Differential: ${fmt(W - U)} MT
                        </div>

                        <div class="summary-grid">
                            <div class="summary-item ${traderTotal >= 0 ? 'profit' : 'loss'}">
                                <div>Trader's Total P&L</div>
                                <div class="summary-value ${traderTotal >= 0 ? 'positive' : 'negative'}">
                                    $${curr(traderTotal)}
                                </div>
                            </div>
                            <div class="summary-item ${murexTotal >= 0 ? 'profit' : 'loss'}">
                                <div>M Total P&L</div>
                                <div class="summary-value ${murexTotal >= 0 ? 'positive' : 'negative'}">
                                    $${curr(murexTotal)}
                                </div>
                            </div>
                        </div>

                        <div class="match-indicator">
                            ‚úì PERFECT MATCH: $${curr(traderTotal)} ‚âà $${curr(murexTotal)}
                        </div>
                    </div>

                    <div class="result-card">
                        <h3>üì¶ Warrant Portfolio Analysis</h3>
                        <div style="max-height: 200px; overflow-y: auto; margin: 1rem 0;">
                            <div class="warrant-grid">
                                ${warrants.map((w, i) => `<div class="warrant-item">#${i+1}<br>${w.toFixed(3)} MT</div>`).join('')}
                            </div>
                        </div>
                        <div style="background: #f0f9ff; padding: 1rem; border-radius: 8px;">
                            <strong>Portfolio Statistics:</strong><br>
                            Average Weight: ${fmt(W / numContracts)} MT per warrant<br>
                            Weight Range: ${fmt(Math.min(...warrants))} - ${fmt(Math.max(...warrants))} MT<br>
                            Total Variance: ${fmt(Math.abs(W - U))} MT from standard position<br>
                            Value Impact: ${W > U ? 'Long' : 'Short'} ${fmt(Math.abs(W - U))} MT √ó $${curr(pWj - pWi)} = <strong>$${curr(weightDiff)}</strong>
                        </div>
                    </div>

                    <div class="result-card" style="border-left: 6px solid #7c3aed;">
                        <h3>üë§ Trader's Portfolio View</h3>
                        
                        <div class="formula">
                            <strong>Weight Differential P&L (Portfolio):</strong><br>
                            (P_wj - P_wi) √ó (Total_Physical - Total_Futures)<br>
                            = ($${curr(pWj)} - $${curr(pWi)}) √ó (${fmt(W)} - ${fmt(U)})<br>
                            = $${curr(pWj - pWi)} √ó ${fmt(W - U)} MT<br>
                            = <strong>$${curr(weightDiff)}</strong>
                        </div>

                        <div class="formula">
                            <strong>Futures Spread P&L (Portfolio):</strong><br>
                            (P_Fj - P_Fi) √ó Total_Futures<br>
                            = ($${curr(pFj)} - $${curr(pFi)}) √ó ${fmt(U)}<br>
                            = $${curr(pFj - pFi)} √ó ${fmt(U)} MT<br>
                            = <strong>$${curr(spreadComponent)}</strong>
                        </div>

                        <div style="background: #f3e8ff; padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                            <strong>Total Portfolio P&L:</strong><br>
                            Weight Differential ($${curr(weightDiff)}) + Spread ($${curr(spreadComponent)}) = <strong>$${curr(traderTotal)}</strong>
                        </div>
                    </div>

                    <div class="result-card" style="border-left: 6px solid #1e40af;">
                        <h3>üíª M Portfolio View</h3>
                        
                        <div class="formula">
                            <strong>Pickup Leg (${numContracts} positions):</strong><br>
                            Future: ${fmt(U)} MT √ó ($${curr(pWi)} - $${curr(pFi)}) = <strong>$${curr(pickupFuture)}</strong><br>
                            Warrant: $0 (nets to zero at pickup)<br>
                            <strong>Pickup Total: $${curr(pickupFuture)}</strong>
                        </div>

                        <div class="formula">
                            <strong>Delivery Leg (${numContracts} positions):</strong><br>
                            Future: -${fmt(U)} MT √ó ($${curr(pWj)} - $${curr(pFj)}) = <strong>$${curr(deliveryFuture)}</strong><br>
                            Warrant: ${fmt(W)} MT √ó ($${curr(pWj)} - $${curr(pWi)}) = <strong>$${curr(deliveryWarrant)}</strong><br>
                            <strong>Delivery Total: $${curr(deliveryFuture + deliveryWarrant)}</strong>
                        </div>

                        <div style="background: #dbeafe; padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                            <strong>Total M P&L:</strong><br>
                            Pickup ($${curr(pickupFuture)}) + Delivery ($${curr(deliveryFuture + deliveryWarrant)}) = <strong>$${curr(murexTotal)}</strong>
                        </div>
                    </div>

                    <div class="result-card" style="border-left: 6px solid #f59e0b;">
                        <h3>üìä Risk Analysis - ${metalData.name} Portfolio</h3>
                        <div style="background: #fef3c7; padding: 1rem; border-radius: 8px;">
                            <strong>Portfolio Risk Metrics:</strong><br>
                            <strong>Metal Exposure:</strong> ${metalData.name} (${metalData.symbol}) - $${metalData.price.toLocaleString()}/tonne market price<br>
                            <strong>Position Size:</strong> ${numContracts} contracts (${fmt(W)} MT physical vs ${fmt(U)} MT futures)<br>
                            <strong>Weight Risk:</strong> ${W > U ? 'Long' : 'Short'} ${fmt(Math.abs(W - U))} MT exposure<br>
                            <strong>Price Sensitivity:</strong> Each $1/tonne move = $${fmt(Math.abs(W - U))} P&L impact on weight differential<br>
                            <strong>Net Position:</strong> ${traderTotal >= 0 ? 'Profitable' : 'Loss'} position of <strong>$${curr(Math.abs(traderTotal))}</strong><br>
                            <strong>Risk/Reward:</strong> ${Math.abs(weightDiff) > Math.abs(spreadComponent) ? 'Weight-driven' : 'Spread-driven'} P&L profile
                        </div>
                    </div>

                    <div class="result-card" style="border-left: 6px solid #ef4444; background: #fef2f2;">
                        <h3>üí∞ Carrying Costs (Information Only)</h3>
                        <div style="background: #fee2e2; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                            <p style="color: #991b1b; margin-bottom: 0.5rem;"><strong>‚ÑπÔ∏è Note:</strong> These costs are shown for information only and are NOT included in the P&L calculation above.</p>
                        </div>
                        
                        <div style="background: #e0f2fe; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem; font-size: 0.9rem;">
                            <strong>üìÖ Day Count Calculation:</strong><br>
                            Pickup Date: ${pickupDate.toLocaleDateString('en-GB')} (${pickupDate.toLocaleDateString('en-US', {weekday: 'short', year: 'numeric', month: 'short', day: 'numeric'})})<br>
                            Delivery Date: ${deliveryDate.toLocaleDateString('en-GB')} (${deliveryDate.toLocaleDateString('en-US', {weekday: 'short', year: 'numeric', month: 'short', day: 'numeric'})})<br>
                            <strong>Days Between: ${autoDayCount} days</strong> (all calendar days including weekends)
                            ${rentDayCountOverride && rentDayCountOverride > 0 ? `<br><span style="color: #f59e0b;">‚ö†Ô∏è Rent day count overridden: ${rentDayCount} days</span>` : ''}
                            ${sofrDayCountOverride && sofrDayCountOverride > 0 ? `<br><span style="color: #f59e0b;">‚ö†Ô∏è SOFR day count overridden: ${sofrDayCount} days</span>` : ''}
                        </div>
                        
                        <div class="formula">
                            <strong>Rent Cost:</strong><br>
                            ${fmt(rentRate)} USD/MT/day √ó ${fmt(W)} MT √ó ${rentDayCount} days ${rentDayCountOverride && rentDayCountOverride > 0 ? '<span style="color: #f59e0b;">(manual override)</span>' : ''}<br>
                            = <strong style="color: #ef4444;">$${curr(rentCost)}</strong>
                        </div>

                        <div class="formula">
                            <strong>Fixed Fees:</strong><br>
                            $${fmt(fixedFeesPerLot)} per lot (Clearing: $${fmt(feesClearing)} + LME: $${fmt(feesLME)} + Macquarie: $${fmt(feesMacquarie)}) √ó ${Math.round(numLots)} lot${Math.round(numLots) !== 1 ? 's' : ''}<br>
                            = <strong style="color: #ef4444;">$${curr(totalFixedFees)}</strong>
                        </div>

                        <div class="formula">
                            <strong>Financing Cost (SOFR ${fmt(sofrRate)}%, ACT/360):</strong><br>
                            ${fmt(sofrRate)}% / 360 √ó ${sofrDayCount} days ${sofrDayCountOverride && sofrDayCountOverride > 0 ? '<span style="color: #f59e0b;">(manual override)</span>' : ''} √ó $${curr(pWi)} √ó ${metalData.lotSize} MT √ó ${Math.round(numLots)} lot${Math.round(numLots) !== 1 ? 's' : ''}<br>
                            = <strong style="color: #ef4444;">$${curr(financingCost)}</strong>
                        </div>

                        <div style="background: #fee2e2; padding: 1rem; border-radius: 8px; margin-top: 1rem; border: 2px solid #ef4444;">
                            <strong style="font-size: 1.1rem;">Total Carrying Costs:</strong><br>
                            Rent ($${curr(rentCost)}) + Fees ($${curr(totalFixedFees)}) + Financing ($${curr(financingCost)})<br>
                            = <strong style="color: #991b1b; font-size: 1.2rem;">$${curr(totalCarryingCosts)}</strong>
                        </div>

                        <div style="background: #dbeafe; padding: 1rem; border-radius: 8px; margin-top: 1rem; border: 2px solid #3b82f6;">
                            <strong style="font-size: 1.1rem; color: #1e40af;">üí∞ Cash and Carry (Information Only):</strong><br>
                            <div style="margin-top: 0.5rem; font-size: 0.95rem;">
                                Future Spread: ($${fmt(pFj)} - $${fmt(pFi)}) √ó ${fmt(U)} MT = <strong>$${curr(spreadComponent)}</strong><br>
                                Total Carrying Costs: <strong>$${curr(totalCarryingCosts)}</strong><br>
                                <div style="border-top: 2px solid #3b82f6; margin-top: 0.5rem; padding-top: 0.5rem;">
                                    <strong style="font-size: 1.05rem;">Cash and Carry = Future Spread - Carrying Costs</strong><br>
                                    = <strong style="color: ${(spreadComponent - totalCarryingCosts) >= 0 ? '#059669' : '#dc2626'}; font-size: 1.2rem;">$${curr(spreadComponent - totalCarryingCosts)}</strong>
                                </div>
                            </div>
                        </div>

                        <div style="background: #fef3c7; padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                            <strong>Net P&L After Carrying Costs:</strong><br>
                            Trading P&L ($${curr(traderTotal)}) + Carrying Costs ($${curr(totalCarryingCosts)})<br>
                            = <strong style="color: ${(traderTotal + totalCarryingCosts) >= 0 ? '#10b981' : '#ef4444'};">$${curr(traderTotal + totalCarryingCosts)}</strong>
                        </div>
                    </div>
                `;

                document.getElementById('resultsPanel').innerHTML = html;
            }, 800);
        }

        function exportToExcel() {
            if (warrants.length === 0) {
                alert('Please generate warrants first!');
                return;
            }

            const selectedMetal = document.getElementById('metalSelector').value;
            const metalData = METAL_PRICES[selectedMetal];
            const numContracts = warrants.length;
            const W = warrants.reduce((sum, w) => sum + w, 0);
            const U = numContracts * metalData.lotSize;
            const pFi = parseFloat(document.getElementById('pFi').value.replace(/,/g, '.'));
            const pWi = parseFloat(document.getElementById('pWi').value.replace(/,/g, '.'));
            const pFj = parseFloat(document.getElementById('pFj').value.replace(/,/g, '.'));
            const pWj = parseFloat(document.getElementById('pWj').value.replace(/,/g, '.'));
            
            // Carrying costs
            const rentRate = parseFloat(document.getElementById('rentRate').value.replace(/,/g, '.'));
            const sofrRate = parseFloat(document.getElementById('sofrRate').value.replace(/,/g, '.'));
            const feesClearing = parseFloat(document.getElementById('feesClearing').value.replace(/,/g, '.'));
            const feesLME = parseFloat(document.getElementById('feesLME').value.replace(/,/g, '.'));
            const feesMacquarie = parseFloat(document.getElementById('feesMacquarie').value.replace(/,/g, '.'));
            
            const wb = XLSX.utils.book_new();
            
            // Warrants sheet
            const warrantsData = [
                ['WARRANT DETAILS'],
                ['Metal: ' + metalData.name + ' (' + metalData.symbol + ')'],
                [],
                ['Warrant #', 'Weight (MT)'],
                ...warrants.map((w, i) => [i + 1, w]),
                [],
                ['SUMMARY', ''],
                ['Total Warrants', numContracts],
                ['Total Physical Weight (W)', W],
                ['Total Futures (U)', U],
                ['Weight Differential (W-U)', W - U]
            ];
            const wsWarrants = XLSX.utils.aoa_to_sheet(warrantsData);
            wsWarrants['!cols'] = [{ wch: 15 }, { wch: 15 }];
            XLSX.utils.book_append_sheet(wb, wsWarrants, 'Warrants');

            // Inputs sheet
            const inputsData = [
                ['LME P&L CALCULATOR - MULTI-CONTRACT INPUTS'],
                ['Metal: ' + metalData.name + ' (' + metalData.symbol + ')'],
                [],
                ['Parameter', 'Symbol', 'Value', 'Unit'],
                ['Number of Contracts', 'n', numContracts, 'contracts'],
                ['Physical Weight', 'W', W, 'MT'],
                ['Futures Size', 'U', U, 'MT'],
                ['Weight Differential', 'W - U', W - U, 'MT'],
                [],
                ['PICKUP LEG', '', '', ''],
                ['Future Price', 'P_Fi', pFi, 'USD/MT'],
                ['Warrant Price', 'P_wi', pWi, 'USD/MT'],
                ['Price Difference', 'P_wi - P_Fi', pWi - pFi, 'USD/MT'],
                [],
                ['DELIVERY LEG', '', '', ''],
                ['Future Price', 'P_Fj', pFj, 'USD/MT'],
                ['Warrant Price', 'P_wj', pWj, 'USD/MT'],
                ['Price Difference', 'P_wj - P_Fj', pWj - pFj, 'USD/MT'],
                ['Warrant Price Change', 'P_wj - P_wi', pWj - pWi, 'USD/MT'],
                ['Future Spread', 'P_Fj - P_Fi', pFj - pFi, 'USD/MT'],
                [],
                ['CARRYING COSTS', '', '', ''],
                ['Rent Rate', '', rentRate, 'USD/MT/day'],
                ['SOFR Rate', '', sofrRate, '%'],
                ['Clearing Fees', '', feesClearing, 'USD/lot'],
                ['LME Fees', '', feesLME, 'USD/lot'],
                ['Macquarie Fees', '', feesMacquarie, 'USD/lot']
            ];
            const wsInputs = XLSX.utils.aoa_to_sheet(inputsData);
            wsInputs['!cols'] = [{ wch: 30 }, { wch: 15 }, { wch: 15 }, { wch: 10 }];
            XLSX.utils.book_append_sheet(wb, wsInputs, 'Inputs');

            // Trader View Sheet
            const weightDiff = (pWj - pWi) * (W - U);
            const spreadPL = (pFj - pFi) * U;
            const pickupLegFuture = U * (pWi - pFi);
            const pickupLegTotal = pickupLegFuture;
            const deliveryLegSpread = spreadPL - pickupLegFuture;
            const deliveryLegTotal = weightDiff + deliveryLegSpread;
            const totalPL = pickupLegTotal + deliveryLegTotal;
            
            const traderData = [
                ['TRADER VIEW - P&L CALCULATION'],
                [],
                ['Component', 'Formula', 'Calculation', 'Result (USD)'],
                [],
                ['COMPONENT 1: Weight Differential P&L', '', '', ''],
                ['  P_wj - P_wi', '', pWj - pWi, ''],
                ['  W - U', '', W - U, ''],
                ['  Weight Diff P&L', '(P_wj - P_wi) √ó (W - U)', '', weightDiff],
                [],
                ['COMPONENT 2: Futures Spread P&L', '', '', ''],
                ['  P_Fj - P_Fi', '', pFj - pFi, ''],
                ['  U', '', U, ''],
                ['  Spread P&L', '(P_Fj - P_Fi) √ó U', '', spreadPL],
                [],
                ['LEG BREAKDOWN', '', '', ''],
                [],
                ['PICKUP LEG P&L', '', '', ''],
                ['  Future', 'U √ó (P_wi - P_Fi)', '', pickupLegFuture],
                ['  Warrant', '', '', 0],
                ['  Pickup Total', '', '', pickupLegTotal],
                [],
                ['DELIVERY LEG P&L', '', '', ''],
                ['  Weight Differential', '', '', weightDiff],
                ['  Spread (net of pickup)', '', '', deliveryLegSpread],
                ['  Delivery Total', '', '', deliveryLegTotal],
                [],
                ['TOTAL P&L', '', '', totalPL]
            ];
            
            const wsTrader = XLSX.utils.aoa_to_sheet(traderData);
            wsTrader['!cols'] = [{ wch: 30 }, { wch: 30 }, { wch: 20 }, { wch: 15 }];
            XLSX.utils.book_append_sheet(wb, wsTrader, 'Trader View');
            
            // M View Sheet
            const pickupFuturePL = U * (pWi - pFi);
            const deliveryFuturePL = U * (pFj - pWj);
            const pickupWarrantPL = W * (pWi - pWi);
            const deliveryWarrantPL = W * (pWj - pWi);
            const totalMPL = pickupFuturePL + deliveryFuturePL + pickupWarrantPL + deliveryWarrantPL;
            
            const murexData = [
                ['M VIEW - P&L CALCULATION'],
                [],
                ['Component', 'Formula', 'Calculation', 'Result (USD)'],
                [],
                ['PICKUP LEG', '', '', ''],
                ['  Future P&L', 'U √ó (P_wi - P_Fi)', '', pickupFuturePL],
                ['  Warrant P&L', 'W √ó (P_wi - P_wi)', '', pickupWarrantPL],
                ['  Pickup Total', '', '', pickupFuturePL + pickupWarrantPL],
                [],
                ['DELIVERY LEG', '', '', ''],
                ['  Future P&L', 'U √ó (P_Fj - P_wj)', '', deliveryFuturePL],
                ['  Warrant P&L', 'W √ó (P_wj - P_wi)', '', deliveryWarrantPL],
                ['  Delivery Total', '', '', deliveryFuturePL + deliveryWarrantPL],
                [],
                ['TOTAL P&L', '', '', totalMPL],
                [],
                ['NOTE: Trader View P&L = M View P&L', '', '', '']
            ];
            
            const wsMurex = XLSX.utils.aoa_to_sheet(murexData);
            wsMurex['!cols'] = [{ wch: 30 }, { wch: 30 }, { wch: 20 }, { wch: 15 }];
            XLSX.utils.book_append_sheet(wb, wsMurex, 'M View');
            
            const timestamp = new Date().toISOString().slice(0, 10);
            XLSX.writeFile(wb, `LME_${metalData.symbol}_Multi_${numContracts}contracts_${timestamp}.xlsx`);
        }

        // Normalize number input (accept both comma and dot)
        function normalizeNumberInput(input) {
            if (!input) return input;
            const element = document.getElementById(input);
            if (element && element.value) {
                element.value = element.value.replace(/,/g, '.');
            }
        }

        // Update fees total
        function updateFeesTotal() {
            const clearing = parseFloat(document.getElementById('feesClearing').value.replace(/,/g, '.')) || 0;
            const lme = parseFloat(document.getElementById('feesLME').value.replace(/,/g, '.')) || 0;
            const macquarie = parseFloat(document.getElementById('feesMacquarie').value.replace(/,/g, '.')) || 0;
            const total = (clearing + lme + macquarie).toFixed(2);
            document.getElementById('feesTotal').textContent = total;
        }

        // Manual save with visual feedback
        function manualSaveData() {
            // Normalize all number inputs first
            const numberInputs = ['numContracts', 'minWeight', 'maxWeight', 'pFi', 'pWi', 'pFj', 'pWj', 
                                 'rentRate', 'sofrRate', 'feesClearing', 'feesLME', 'feesMacquarie'];
            numberInputs.forEach(id => normalizeNumberInput(id));
            
            // Save data
            saveFormData();
            
            // Visual feedback
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '‚úÖ Saved!';
            btn.style.background = 'linear-gradient(135deg, #059669 0%, #047857 100%)';
            
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
            }, 2000);
        }

        // Save data to localStorage
        function saveFormData() {
            const formData = {
                metalSelector: document.getElementById('metalSelector').value,
                numContracts: document.getElementById('numContracts').value,
                minWeight: document.getElementById('minWeight').value,
                maxWeight: document.getElementById('maxWeight').value,
                pickupDate: document.getElementById('pickupDate').value,
                deliveryDate: document.getElementById('deliveryDate').value,
                pFi: document.getElementById('pFi').value,
                pWi: document.getElementById('pWi').value,
                pFj: document.getElementById('pFj').value,
                pWj: document.getElementById('pWj').value,
                rentRate: document.getElementById('rentRate').value,
                sofrRate: document.getElementById('sofrRate').value,
                feesClearing: document.getElementById('feesClearing').value,
                feesLME: document.getElementById('feesLME').value,
                feesMacquarie: document.getElementById('feesMacquarie').value,
                rentDayCountOverride: document.getElementById('rentDayCountOverride').value,
                dayCountOverride: document.getElementById('dayCountOverride').value
            };
            localStorage.setItem('lme_calculator_multi_data', JSON.stringify(formData));
        }

        // Load data from localStorage
        function loadFormData() {
            const savedData = localStorage.getItem('lme_calculator_multi_data');
            if (savedData) {
                try {
                    const formData = JSON.parse(savedData);
                    
                    if (formData.metalSelector) document.getElementById('metalSelector').value = formData.metalSelector;
                    if (formData.numContracts) document.getElementById('numContracts').value = formData.numContracts;
                    if (formData.minWeight) document.getElementById('minWeight').value = formData.minWeight;
                    if (formData.maxWeight) document.getElementById('maxWeight').value = formData.maxWeight;
                    if (formData.pickupDate) document.getElementById('pickupDate').value = formData.pickupDate;
                    if (formData.deliveryDate) document.getElementById('deliveryDate').value = formData.deliveryDate;
                    if (formData.pFi) document.getElementById('pFi').value = formData.pFi;
                    if (formData.pWi) document.getElementById('pWi').value = formData.pWi;
                    if (formData.pFj) document.getElementById('pFj').value = formData.pFj;
                    if (formData.pWj) document.getElementById('pWj').value = formData.pWj;
                    if (formData.rentRate) document.getElementById('rentRate').value = formData.rentRate;
                    if (formData.sofrRate) document.getElementById('sofrRate').value = formData.sofrRate;
                    if (formData.feesClearing) document.getElementById('feesClearing').value = formData.feesClearing;
                    if (formData.feesLME) document.getElementById('feesLME').value = formData.feesLME;
                    if (formData.feesMacquarie) document.getElementById('feesMacquarie').value = formData.feesMacquarie;
                    if (formData.rentDayCountOverride) document.getElementById('rentDayCountOverride').value = formData.rentDayCountOverride;
                    if (formData.dayCountOverride) document.getElementById('dayCountOverride').value = formData.dayCountOverride;
                    
                    // Update metal prices and fees total after loading
                    updateMetalPrices();
                    updateFeesTotal();
                } catch (e) {
                    console.error('Error loading saved data:', e);
                }
            }
        }

        // Clear saved data
        function clearSavedData() {
            if (confirm('Are you sure you want to clear all saved data?')) {
                localStorage.removeItem('lme_calculator_multi_data');
                alert('‚úÖ Saved data cleared successfully!');
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateMetalPrices();
            
            // Load saved data
            loadFormData();
            
            generateWarrants(); // Auto-generate on load
            
            // Auto-normalize comma to dot on blur (when leaving the field)
            const numberInputs = ['numContracts', 'minWeight', 'maxWeight', 'pFi', 'pWi', 'pFj', 'pWj', 
                                 'rentRate', 'sofrRate', 'feesClearing', 'feesLME', 'feesMacquarie'];
            numberInputs.forEach(id => {
                const element = document.getElementById(id);
                element.addEventListener('blur', function() {
                    if (this.value) {
                        this.value = this.value.replace(/,/g, '.');
                        saveFormData(); // Save after normalization
                    }
                });
            });
            
            // Save data on input change
            const allInputs = ['metalSelector', 'numContracts', 'minWeight', 'maxWeight', 'pickupDate', 'deliveryDate', 
                              'pFi', 'pWi', 'pFj', 'pWj', 'rentRate', 'sofrRate', 
                              'feesClearing', 'feesLME', 'feesMacquarie', 'rentDayCountOverride', 'dayCountOverride'];
            allInputs.forEach(id => {
                const element = document.getElementById(id);
                element.addEventListener('input', saveFormData);
                element.addEventListener('change', saveFormData);
            });
            
            // Update fees total on change
            ['feesClearing', 'feesLME', 'feesMacquarie'].forEach(id => {
                document.getElementById(id).addEventListener('input', updateFeesTotal);
                document.getElementById(id).addEventListener('blur', updateFeesTotal);
            });
            
            // Update total futures when contract number changes
            document.getElementById('numContracts').addEventListener('input', function() {
                updateTotalFutures();
                if (warrants.length > 0) {
                    generateWarrants(); // Re-generate warrants for new contract count
                }
            });
        });
    </script>
</body>
</html>
