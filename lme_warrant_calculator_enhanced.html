<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>LME Single Contract Calculator - Enhanced</title>
    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            min-height: 100vh;
            color: #333;
        }

        .navbar {
            background: rgba(0,0,0,0.2);
            backdrop-filter: blur(10px);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .navbar .logo {
            color: white;
            font-size: 1.5rem;
            font-weight: bold;
            text-decoration: none;
        }

        .back-btn {
            color: white;
            text-decoration: none;
            padding: 0.5rem 1rem;
            background: rgba(255,255,255,0.1);
            border-radius: 8px;
            transition: all 0.3s;
        }

        .back-btn:hover {
            background: rgba(255,255,255,0.2);
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
            background: white;
            min-height: calc(100vh - 80px);
            display: grid;
            grid-template-columns: 450px 1fr;
            box-shadow: 0 0 50px rgba(0,0,0,0.3);
        }

        .sidebar {
            background: linear-gradient(180deg, #f8fafc 0%, #e2e8f0 100%);
            padding: 2rem;
            border-right: 1px solid #e2e8f0;
            overflow-y: auto;
            max-height: calc(100vh - 80px);
        }

        .main-content {
            padding: 2rem;
            overflow-y: auto;
            max-height: calc(100vh - 80px);
        }

        .section {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0;
        }

        .section h3 {
            color: #1e40af;
            margin-bottom: 1rem;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            border-bottom: 2px solid #1e40af;
            padding-bottom: 0.5rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.4rem;
            color: #374151;
            font-size: 0.9rem;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 0.7rem;
            border: 2px solid #d1d5db;
            border-radius: 8px;
            font-size: 0.95rem;
            transition: border-color 0.3s;
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #1e40af;
            box-shadow: 0 0 0 3px rgba(30, 64, 175, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }

        .metal-selector {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none !important;
            font-weight: 600;
        }

        .metal-selector option {
            background: white;
            color: #1f2937;
            font-weight: 600;
        }

        .metal-info {
            background: #ecfdf5;
            border: 1px solid #10b981;
            border-radius: 8px;
            padding: 1rem;
            margin-top: 0.5rem;
            font-size: 0.85rem;
        }

        .price-suggestion {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 6px;
            padding: 0.5rem;
            margin-top: 0.3rem;
            font-size: 0.8rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .price-suggestion button {
            background: #f59e0b;
            color: white;
            border: none;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            cursor: pointer;
        }

        .btn {
            width: 100%;
            padding: 0.8rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            margin-top: 0.5rem;
            transition: all 0.3s;
        }

        .btn-primary {
            background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);
            color: white;
        }

        .btn-secondary {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        .result-card {
            background: white;
            border-radius: 12px;
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            border: 1px solid #e2e8f0;
        }

        .result-card h3 {
            margin-bottom: 1rem;
            font-size: 1.2rem;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin: 1rem 0;
        }

        .summary-item {
            text-align: center;
            padding: 1.5rem;
            border-radius: 8px;
        }

        .summary-item.profit {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            border: 1px solid #10b981;
        }

        .summary-item.loss {
            background: linear-gradient(135deg, #fef2f2 0%, #fecaca 100%);
            border: 1px solid #ef4444;
        }

        .summary-value {
            font-size: 1.8rem;
            font-weight: bold;
            margin-top: 0.5rem;
        }

        .summary-value.positive { color: #10b981; }
        .summary-value.negative { color: #ef4444; }

        .formula {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-left: 4px solid #1e40af;
            padding: 1rem;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            margin: 1rem 0;
            line-height: 1.6;
        }

        .match-indicator {
            background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);
            border: 2px solid #10b981;
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
            font-weight: bold;
            color: #059669;
            font-size: 1.1rem;
            margin: 1rem 0;
        }

        .validation-message {
            font-size: 0.8rem;
            padding: 0.5rem;
            border-radius: 6px;
            margin-top: 0.3rem;
        }

        .validation-success {
            background: #ecfdf5;
            color: #059669;
            border: 1px solid #10b981;
        }

        .validation-error {
            background: #fef2f2;
            color: #dc2626;
            border: 1px solid #ef4444;
        }

        .market-status-widget {
            position: fixed;
            top: 100px;
            right: 20px;
            background: rgba(0,0,0,0.9);
            color: white;
            padding: 1rem;
            border-radius: 8px;
            font-size: 0.85rem;
            z-index: 1000;
            min-width: 200px;
        }

        @media (max-width: 1200px) {
            .container {
                grid-template-columns: 1fr;
            }
            
            .sidebar {
                border-right: none;
                border-bottom: 1px solid #e2e8f0;
            }

            .market-status-widget {
                position: static;
                margin: 1rem 0;
            }
        }

        @media (max-width: 768px) {
            .navbar {
                flex-direction: column;
                gap: 1rem;
                padding: 1rem;
                position: sticky;
                top: 0;
                z-index: 1000;
            }

            .navbar .logo {
                font-size: 1.2rem;
            }

            .container {
                margin: 0;
                padding: 1rem;
                padding-top: 80px; /* Account for sticky navbar */
            }

            .sidebar, .main-content {
                padding: 1rem;
            }

            .section {
                padding: 1.25rem;
                margin-bottom: 1.25rem;
                box-shadow: 0 2px 8px rgba(0,0,0,0.15);
            }

            .section h3 {
                font-size: 1.2rem;
                margin-bottom: 1rem;
            }

            .form-group {
                margin-bottom: 1.25rem;
            }

            .form-row {
                grid-template-columns: 1fr;
                gap: 1rem;
            }

            label {
                font-weight: 600;
                margin-bottom: 0.5rem;
                display: block;
            }

            input, select, .btn {
                font-size: 16px; /* Prevents zoom on iOS */
                padding: 1rem;
                border-radius: 10px;
            }

            input, select {
                border: 2px solid #cbd5e1;
                transition: border-color 0.3s;
            }

            input:focus, select:focus {
                border-color: #3b82f6;
                outline: none;
                box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
            }

            .btn {
                min-height: 48px; /* iOS touch target size */
                font-weight: 600;
                letter-spacing: 0.5px;
            }

            .btn-primary, .btn-secondary {
                position: sticky;
                bottom: 1rem;
                z-index: 100;
                box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            }

            .result-card {
                padding: 1.25rem;
                margin-bottom: 1.25rem;
                box-shadow: 0 2px 12px rgba(0,0,0,0.1);
            }

            .result-card h3 {
                font-size: 1.2rem;
                margin-bottom: 1rem;
            }

            .formula {
                font-size: 0.9rem;
                line-height: 1.6;
                padding: 1rem;
            }

            .market-status-widget {
                font-size: 0.85rem;
                padding: 0.75rem;
            }

            small {
                display: block;
                margin-top: 0.5rem;
                line-height: 1.4;
            }

            .price-suggestion {
                padding: 0.75rem;
                margin-top: 0.75rem;
            }

            .price-suggestion button {
                padding: 0.5rem 1rem;
                min-height: 40px;
            }
        }

        @media (max-width: 480px) {
            body {
                font-size: 14px;
            }

            .navbar .logo {
                font-size: 1rem;
            }

            .back-btn {
                padding: 0.4rem 0.8rem;
                font-size: 0.9rem;
            }

            .container {
                padding: 0.5rem;
            }

            .section {
                padding: 0.75rem;
                margin-bottom: 0.75rem;
            }

            .section h3 {
                font-size: 1rem;
                margin-bottom: 0.75rem;
            }

            label {
                font-size: 0.9rem;
            }

            input, select {
                padding: 0.6rem;
            }

            .btn {
                padding: 0.75rem;
                font-size: 0.95rem;
            }

            .result-card {
                padding: 0.75rem;
            }

            .result-card h3 {
                font-size: 1rem;
            }

            .summary-grid {
                grid-template-columns: 1fr;
                gap: 0.5rem;
            }

            .formula {
                font-size: 0.8rem;
                padding: 0.75rem;
            }

            small {
                font-size: 0.75rem;
            }
        }

        /* iOS Safari specific fixes */
        @supports (-webkit-touch-callout: none) {
            input, select, textarea {
                -webkit-appearance: none;
                appearance: none;
                border-radius: 8px;
            }
            
            .btn {
                -webkit-tap-highlight-color: rgba(0,0,0,0.1);
            }
        }

        .loading-spinner {
            display: none;
            text-align: center;
            padding: 3rem;
            color: #6b7280;
        }

        .spinner {
            border: 3px solid #f3f4f6;
            border-top: 3px solid #1e40af;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <script>
        // Authentication check
        if (sessionStorage.getItem('lme_auth_token') !== 'authenticated') {
            window.location.href = 'login.html';
        }
    </script>

    <div class="navbar">
        <a href="index.html" class="logo">üî¢ LME Calculator Suite</a>
        <a href="index.html" class="back-btn">‚Üê Back to Home</a>
    </div>

    <div class="market-status-widget" id="marketStatus">
        <div><strong>üåê LME Status</strong></div>
        <div id="tradingStatus">üî¥ Loading...</div>
        <div id="londonTime">London: --:--:--</div>
    </div>

    <div class="container">
        <div class="sidebar">
            <div class="section">
                <h3>üè≠ Metal Selection</h3>
                <div class="form-group">
                    <label>Base Metal</label>
                    <select id="metalSelector" class="metal-selector" onchange="updateMetalPrices()">
                        <option value="CU">Copper (Cu) - $9,779/tonne</option>
                        <option value="AL">Aluminium (Al) - $2,697/tonne</option>
                        <option value="NI">Nickel (Ni) - $15,185/tonne</option>
                        <option value="ZN">Zinc (Zn) - $2,992/tonne</option>
                        <option value="PB">Lead (Pb) - $2,013/tonne</option>
                        <option value="SN">Tin (Sn) - $35,410/tonne</option>
                    </select>
                    <div class="metal-info" id="metalInfo">
                        <strong>Copper (Cu)</strong><br>
                        Current Price: $9,779/tonne<br>
                        Standard Lot: 25 tonnes<br>
                        Contract Currency: USD
                    </div>
                </div>
            </div>

            <div class="section">
                <h3>üìã Trade Parameters</h3>
                <div class="form-group">
                    <label>Physical Warrant Weight (MT)</label>
                    <input type="text" inputmode="decimal" id="weight" value="24.794" pattern="[0-9.,]*">
                    <small style="color: #6b7280;">Enter actual warrant weight</small>
                </div>
                <div class="form-group">
                    <label>Standard Lot Size (MT)</label>
                    <input type="number" id="lotSize" value="25" step="0.001" min="0" readonly style="background: #f3f4f6;">
                </div>
            </div>

            <div class="section">
                <h3>üìÖ Pickup Leg</h3>
                <div class="form-group">
                    <label>Future Purchase Date</label>
                    <input type="date" id="pickupPurchaseDate" value="2025-10-01" onchange="validateDate(this)">
                    <div id="pickupPurchaseDateValidation" class="validation-message"></div>
                </div>
                <div class="form-group">
                    <label>Future Expiry/Pickup Date</label>
                    <input type="date" id="pickupDate" value="2025-10-16" onchange="validateDate(this)">
                    <div id="pickupDateValidation" class="validation-message"></div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Future Price (P<sub>Fi</sub>)</label>
                        <input type="text" inputmode="decimal" id="pFi" value="9750.00" pattern="[0-9.,]*" oninput="showPriceSuggestion(this)">
                        <div id="pFiSuggestion" class="price-suggestion" style="display: none;">
                            <span>Suggested: $<span id="pFiSuggestedValue">9750</span></span>
                            <button onclick="applySuggestedPrice('pFi')">Apply</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Warrant Price (P<sub>wi</sub>)</label>
                        <input type="text" inputmode="decimal" id="pWi" value="9779.00" pattern="[0-9.,]*" oninput="showPriceSuggestion(this)">
                        <div id="pWiSuggestion" class="price-suggestion" style="display: none;">
                            <span>Suggested: $<span id="pWiSuggestedValue">9779</span></span>
                            <button onclick="applySuggestedPrice('pWi')">Apply</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="section">
                <h3>üìÖ Delivery Leg</h3>
                <div class="form-group">
                    <label>Future Purchase Date</label>
                    <input type="date" id="deliveryPurchaseDate" value="2025-10-15" onchange="validateDate(this)">
                    <div id="deliveryPurchaseDateValidation" class="validation-message"></div>
                </div>
                <div class="form-group">
                    <label>Future Expiry/Delivery Date</label>
                    <input type="date" id="deliveryDate" value="2025-11-14" onchange="validateDate(this)">
                    <div id="deliveryDateValidation" class="validation-message"></div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Future Price (P<sub>Fj</sub>)</label>
                        <input type="text" inputmode="decimal" id="pFj" value="9820.00" pattern="[0-9.,]*" oninput="showPriceSuggestion(this)">
                        <div id="pFjSuggestion" class="price-suggestion" style="display: none;">
                            <span>Suggested: $<span id="pFjSuggestedValue">9820</span></span>
                            <button onclick="applySuggestedPrice('pFj')">Apply</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Warrant Price (P<sub>wj</sub>)</label>
                        <input type="text" inputmode="decimal" id="pWj" value="9850.00" pattern="[0-9.,]*" oninput="showPriceSuggestion(this)">
                        <div id="pWjSuggestion" class="price-suggestion" style="display: none;">
                            <span>Suggested: $<span id="pWjSuggestedValue">9850</span></span>
                            <button onclick="applySuggestedPrice('pWj')">Apply</button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="section">
                <h3>üí∞ Carrying Costs (Information Only)</h3>
                <div class="form-group">
                    <label>Rent Rate (USD/MT/day)</label>
                    <input type="text" inputmode="decimal" id="rentRate" value="0.55" pattern="[0-9.,]*">
                    <small style="color: #6b7280;">Default: 0.55 per MT per day (all days)</small>
                </div>
                <div class="form-group">
                    <label>Rent Day Count Override (optional)</label>
                    <input type="text" inputmode="numeric" id="rentDayCountOverride" value="" pattern="[0-9]*" placeholder="Leave empty for auto">
                    <small style="color: #6b7280;">Override day count for rent calculation only</small>
                </div>
                <div class="form-group">
                    <label>SOFR Rate (%)</label>
                    <input type="text" inputmode="decimal" id="sofrRate" value="4.50" pattern="[0-9.,]*">
                    <small style="color: #6b7280;">For financing cost calculation (ACT/360)</small>
                </div>
                <div class="form-group">
                    <label>SOFR Day Count Override (optional)</label>
                    <input type="text" inputmode="numeric" id="dayCountOverride" value="" pattern="[0-9]*" placeholder="Leave empty for auto">
                    <small style="color: #6b7280;">Override day count for SOFR financing only</small>
                </div>
                <div class="form-group" style="background: #fef3c7; padding: 0.8rem; border-radius: 8px; margin-top: 1rem;">
                    <strong style="color: #92400e; display: block; margin-bottom: 0.5rem;">Fixed Fees per Lot (Editable):</strong>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 0.5rem; margin-bottom: 0.5rem;">
                        <div>
                            <label style="font-size: 0.75rem; color: #78350f; display: block; margin-bottom: 0.2rem;">Clearing ($)</label>
                            <input type="number" inputmode="decimal" id="feesClearing" value="2.40" step="0.01" min="0" style="font-size: 0.85rem; padding: 0.4rem;">
                        </div>
                        <div>
                            <label style="font-size: 0.75rem; color: #78350f; display: block; margin-bottom: 0.2rem;">LME Fees ($)</label>
                            <input type="number" inputmode="decimal" id="feesLME" value="1.84" step="0.01" min="0" style="font-size: 0.85rem; padding: 0.4rem;">
                        </div>
                    </div>
                    <div style="margin-bottom: 0.5rem;">
                        <label style="font-size: 0.75rem; color: #78350f; display: block; margin-bottom: 0.2rem;">Macquarie ($)</label>
                        <input type="number" inputmode="decimal" id="feesMacquarie" value="0.55" step="0.01" min="0" style="font-size: 0.85rem; padding: 0.4rem; width: calc(50% - 0.25rem);">
                    </div>
                    <div style="background: #fbbf24; padding: 0.4rem; border-radius: 4px; text-align: center;">
                        <strong style="color: #78350f;">Total: $<span id="feesTotal">4.79</span> per lot</strong>
                    </div>
                </div>
            </div>

            <button class="btn btn-primary" onclick="calculate()">
                üìä Calculate P&L Reconciliation
            </button>
            <button class="btn btn-secondary" onclick="exportToExcel()">
                üìã Export to Excel
            </button>
            <button class="btn" onclick="manualSaveData()" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white; margin-top: 0.5rem;">
                üíæ Save Data
            </button>
            <button class="btn" onclick="clearSavedData()" style="background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; margin-top: 0.5rem;">
                üóëÔ∏è Clear Saved Data
            </button>
        </div>

        <div class="main-content" id="resultsPanel">
            <div class="loading-spinner" id="loadingSpinner">
                <div class="spinner"></div>
                <h3>Enter parameters and click Calculate</h3>
                <p>Your P&L reconciliation will appear here with detailed mathematical breakdowns</p>
            </div>
        </div>
    </div>

    <script>
        // Metal price data
        const METAL_PRICES = {
            AL: { name: 'Aluminium', price: 2697.25, symbol: 'Al', lotSize: 25 },
            CU: { name: 'Copper', price: 9779.00, symbol: 'Cu', lotSize: 25 },
            PB: { name: 'Lead', price: 2013.00, symbol: 'Pb', lotSize: 25 },
            NI: { name: 'Nickel', price: 15185.00, symbol: 'Ni', lotSize: 6 },
            ZN: { name: 'Zinc', price: 2992.00, symbol: 'Zn', lotSize: 25 },
            SN: { name: 'Tin', price: 35410.00, symbol: 'Sn', lotSize: 5 }
        };

        // LME Holidays for validation
        const LME_HOLIDAYS = {
            2025: ['2025-01-01', '2025-04-18', '2025-04-21', '2025-05-05', '2025-05-26', '2025-08-25', '2025-12-25', '2025-12-26'],
            2026: ['2026-01-01', '2026-04-03', '2026-04-06', '2026-05-04', '2026-05-25', '2026-08-31', '2026-12-25', '2026-12-28']
        };

        function updateMetalPrices() {
            const selectedMetal = document.getElementById('metalSelector').value;
            const metalData = METAL_PRICES[selectedMetal];
            
            // Update lot size field automatically
            document.getElementById('lotSize').value = metalData.lotSize;
            
            // Update metal info
            document.getElementById('metalInfo').innerHTML = `
                <strong>${metalData.name} (${metalData.symbol})</strong><br>
                Current Price: $${metalData.price.toLocaleString()}/tonne<br>
                Standard Lot: ${metalData.lotSize} tonnes<br>
                Contract Currency: USD
            `;

            // Generate realistic price variations
            const basePrice = metalData.price;
            const variation = basePrice * 0.02; // 2% variation
            
            // Update suggested prices
            const prices = {
                pFi: (basePrice - Math.random() * variation).toFixed(2),
                pWi: (basePrice + Math.random() * variation * 0.5).toFixed(2),
                pFj: (basePrice + Math.random() * variation).toFixed(2),
                pWj: (basePrice + Math.random() * variation * 1.2).toFixed(2)
            };

            // Update form values
            document.getElementById('pFi').value = prices.pFi;
            document.getElementById('pWi').value = prices.pWi;
            document.getElementById('pFj').value = prices.pFj;
            document.getElementById('pWj').value = prices.pWj;

            // Update suggestion values
            document.getElementById('pFiSuggestedValue').textContent = prices.pFi;
            document.getElementById('pWiSuggestedValue').textContent = prices.pWi;
            document.getElementById('pFjSuggestedValue').textContent = prices.pFj;
            document.getElementById('pWjSuggestedValue').textContent = prices.pWj;

            // Recalculate if results are showing
            if (document.querySelector('.result-card')) {
                calculate();
            }
        }

        function showPriceSuggestion(input) {
            const suggestionId = input.id + 'Suggestion';
            const suggestion = document.getElementById(suggestionId);
            if (suggestion) {
                suggestion.style.display = 'flex';
                setTimeout(() => {
                    suggestion.style.display = 'none';
                }, 5000);
            }
        }

        function applySuggestedPrice(fieldId) {
            const suggestedValue = document.getElementById(fieldId + 'SuggestedValue').textContent;
            document.getElementById(fieldId).value = suggestedValue;
            document.getElementById(fieldId + 'Suggestion').style.display = 'none';
        }

        function validateDate(input) {
            const dateStr = input.value;
            const validationDiv = document.getElementById(input.id + 'Validation');
            
            if (!dateStr) {
                validationDiv.textContent = '';
                validationDiv.className = 'validation-message';
                return;
            }

            const isValid = isLMETradingDay(dateStr);
            
            if (isValid) {
                validationDiv.textContent = '‚úÖ Valid LME trading day';
                validationDiv.className = 'validation-message validation-success';
            } else {
                validationDiv.textContent = '‚ö†Ô∏è Non-trading day (weekend or holiday)';
                validationDiv.className = 'validation-message validation-error';
            }
        }

        function isLMETradingDay(dateStr) {
            const date = new Date(dateStr);
            const dayOfWeek = date.getDay();
            
            // Check if weekend
            if (dayOfWeek === 0 || dayOfWeek === 6) return false;
            
            // Check if holiday
            const year = date.getFullYear();
            const holidays = LME_HOLIDAYS[year] || [];
            return !holidays.includes(dateStr);
        }

        function getCurrentMarketStatus() {
            const now = new Date();
            const londonTime = new Date(now.toLocaleString("en-US", {timeZone: "Europe/London"}));
            const hours = londonTime.getHours();
            const minutes = londonTime.getMinutes();
            const currentTime = hours * 60 + minutes;
            
            const ringStart = 11 * 60 + 40;
            const ringEnd = 17 * 60;
            const selectStart = 1 * 60;
            const selectEnd = 19 * 60;
            
            let status = 'üî¥ Markets Closed';
            
            if (currentTime >= selectStart && currentTime < selectEnd) {
                status = 'üü¢ LMEselect Open';
            }
            
            if (currentTime >= ringStart && currentTime < ringEnd) {
                status = 'üü° Ring + Select';
            }
            
            return { status, londonTime };
        }

        function updateMarketStatus() {
            const marketData = getCurrentMarketStatus();
            document.getElementById('tradingStatus').textContent = marketData.status;
            document.getElementById('londonTime').textContent = 
                `London: ${marketData.londonTime.toLocaleTimeString('en-GB', {hour12: false})}`;
        }

        function calculate() {
            // Show loading (recreate if it doesn't exist)
            const resultsPanel = document.getElementById('resultsPanel');
            const loadingSpinner = document.getElementById('loadingSpinner');
            
            if (!loadingSpinner) {
                resultsPanel.innerHTML = `
                    <div class="loading-spinner" id="loadingSpinner" style="display: block;">
                        <div class="spinner"></div>
                        <h3>Calculating...</h3>
                        <p>Processing your P&L reconciliation</p>
                    </div>
                `;
            } else {
                loadingSpinner.style.display = 'block';
            }
            
            setTimeout(() => {
                // Normalize and parse inputs (accept both comma and dot)
                const W = parseFloat(document.getElementById('weight').value.replace(/,/g, '.'));
                const U = parseFloat(document.getElementById('lotSize').value.replace(/,/g, '.'));
                const pFi = parseFloat(document.getElementById('pFi').value.replace(/,/g, '.'));
                const pWi = parseFloat(document.getElementById('pWi').value.replace(/,/g, '.'));
                const pFj = parseFloat(document.getElementById('pFj').value.replace(/,/g, '.'));
                const pWj = parseFloat(document.getElementById('pWj').value.replace(/,/g, '.'));
                
                const selectedMetal = document.getElementById('metalSelector').value;
                const metalData = METAL_PRICES[selectedMetal];

                // Get dates for carrying cost calculation
                const pickupDate = new Date(document.getElementById('pickupDate').value);
                const deliveryDate = new Date(document.getElementById('deliveryDate').value);
                
                // Day count: use override if provided, otherwise calculate from dates
                const autoDayCount = Math.max(0, Math.floor((deliveryDate - pickupDate) / (1000 * 60 * 60 * 24)));
                
                // Separate overrides for Rent and SOFR
                const rentDayCountOverride = parseInt(document.getElementById('rentDayCountOverride').value);
                const rentDayCount = (rentDayCountOverride && rentDayCountOverride > 0) ? rentDayCountOverride : autoDayCount;
                
                const sofrDayCountOverride = parseInt(document.getElementById('dayCountOverride').value);
                const sofrDayCount = (sofrDayCountOverride && sofrDayCountOverride > 0) ? sofrDayCountOverride : autoDayCount;
                
                // Carrying costs (all negative as they are costs)
                const rentRate = parseFloat(document.getElementById('rentRate').value.replace(/,/g, '.'));
                const sofrRate = parseFloat(document.getElementById('sofrRate').value.replace(/,/g, '.'));
                const numLots = W / U;
                
                // Rent: rate * weight * days (all days including weekends)
                const rentCost = -Math.abs(rentRate * W * rentDayCount);
                
                // Fixed fees: per lot (editable)
                const feesClearing = parseFloat(document.getElementById('feesClearing').value.replace(/,/g, '.')) || 2.40;
                const feesLME = parseFloat(document.getElementById('feesLME').value.replace(/,/g, '.')) || 1.84;
                const feesMacquarie = parseFloat(document.getElementById('feesMacquarie').value.replace(/,/g, '.')) || 0.55;
                const fixedFeesPerLot = feesClearing + feesLME + feesMacquarie;
                const totalFixedFees = -Math.abs(fixedFeesPerLot * numLots);
                
                // Financing: SOFR rate % / 360 * daycount * warrant price * lotSize * notional
                // For TOM future with pickup, borrowing cost
                const financingCost = -Math.abs((sofrRate / 100 / 360) * sofrDayCount * pWi * metalData.lotSize * numLots);
                
                const totalCarryingCosts = rentCost + totalFixedFees + financingCost;

                // Calculate P&L
                const weightDiff = (pWj - pWi) * (W - U);
                const spreadComponent = (pFj - pFi) * U;
                const traderTotal = weightDiff + spreadComponent;

                const pickupFuture = U * (pWi - pFi);
                const deliveryFuture = -U * (pWj - pFj);
                const deliveryWarrant = W * (pWj - pWi);
                const murexTotal = pickupFuture + deliveryFuture + deliveryWarrant;

                const fmt = (n) => n.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",");
                const curr = (n) => (n >= 0 ? '' : '') + n.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ",");

                const html = `
                    <div class="result-card" style="border-left: 6px solid #10b981;">
                        <h3>‚úÖ P&L Reconciliation Summary - ${metalData.name} (${metalData.symbol})</h3>
                        <div class="summary-grid">
                            <div class="summary-item ${traderTotal >= 0 ? 'profit' : 'loss'}">
                                <div>Trader P&L</div>
                                <div class="summary-value ${traderTotal >= 0 ? 'positive' : 'negative'}">
                                    $${curr(traderTotal)}
                                </div>
                            </div>
                            <div class="summary-item ${murexTotal >= 0 ? 'profit' : 'loss'}">
                                <div>M P&L</div>
                                <div class="summary-value ${murexTotal >= 0 ? 'positive' : 'negative'}">
                                    $${curr(murexTotal)}
                                </div>
                            </div>
                        </div>
                        <div class="match-indicator">
                            ‚úì PERFECT MATCH: $${curr(traderTotal)} ‚âà $${curr(murexTotal)}
                            <br><small>Difference: $${curr(Math.abs(traderTotal - murexTotal))}</small>
                        </div>
                    </div>

                    <div class="result-card" style="border-left: 6px solid #7c3aed;">
                        <h3>üë§ Trader's Conceptual View</h3>
                        
                        <div class="formula">
                            <strong>Component 1: Weight Differential P&L</strong><br>
                            (P_wj - P_wi) √ó (W - U)<br>
                            = ($${fmt(pWj)} - $${fmt(pWi)}) √ó (${fmt(W)} - ${fmt(U)})<br>
                            = $${fmt(pWj - pWi)} √ó ${fmt(W - U)} MT<br>
                            = <strong style="color: ${weightDiff >= 0 ? '#10b981' : '#ef4444'};">$${curr(weightDiff)}</strong>
                        </div>

                        <div class="formula">
                            <strong>Component 2: Futures Spread P&L</strong><br>
                            (P_Fj - P_Fi) √ó U<br>
                            = ($${fmt(pFj)} - $${fmt(pFi)}) √ó ${fmt(U)}<br>
                            = $${fmt(pFj - pFi)} √ó ${fmt(U)} MT<br>
                            = <strong style="color: ${spreadComponent >= 0 ? '#10b981' : '#ef4444'};">$${curr(spreadComponent)}</strong>
                        </div>

                        <div style="background: #f3e8ff; padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                            <strong>Total Trader P&L:</strong><br>
                            Weight Diff ($${curr(weightDiff)}) + Spread ($${curr(spreadComponent)}) = <strong>$${curr(traderTotal)}</strong>
                        </div>
                    </div>

                    <div class="result-card" style="border-left: 6px solid #1e40af;">
                        <h3>üíª M System View</h3>
                        
                        <div class="formula">
                            <strong>Pickup Leg P&L:</strong><br>
                            Future: U √ó (P_wi - P_Fi) = ${fmt(U)} √ó ($${fmt(pWi)} - $${fmt(pFi)}) = <strong>$${curr(pickupFuture)}</strong><br>
                            Warrant: $0 (nets to zero at pickup)<br>
                            <strong>Pickup Total: $${curr(pickupFuture)}</strong>
                        </div>

                        <div class="formula">
                            <strong>Delivery Leg P&L:</strong><br>
                            Future: -U √ó (P_wj - P_Fj) = -${fmt(U)} √ó ($${fmt(pWj)} - $${fmt(pFj)}) = <strong>$${curr(deliveryFuture)}</strong><br>
                            Warrant: W √ó (P_wj - P_wi) = ${fmt(W)} √ó ($${fmt(pWj)} - $${fmt(pWi)}) = <strong>$${curr(deliveryWarrant)}</strong><br>
                            <strong>Delivery Total: $${curr(deliveryFuture + deliveryWarrant)}</strong>
                        </div>

                        <div style="background: #dbeafe; padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                            <strong>Total M P&L:</strong><br>
                            Pickup ($${curr(pickupFuture)}) + Delivery ($${curr(deliveryFuture + deliveryWarrant)}) = <strong>$${curr(murexTotal)}</strong>
                        </div>
                    </div>

                    <div class="result-card" style="border-left: 6px solid #f59e0b;">
                        <h3>üìä Market Context - ${metalData.name} Analysis</h3>
                        <div style="background: #fef3c7; padding: 1rem; border-radius: 8px;">
                            <strong>Metal:</strong> ${metalData.name} (${metalData.symbol})<br>
                            <strong>Market Price:</strong> $${metalData.price.toLocaleString()}/tonne<br>
                            <strong>Position Size:</strong> ${fmt(W)} MT physical vs ${fmt(U)} MT futures<br>
                            <strong>Weight Impact:</strong> ${W > U ? 'Long' : 'Short'} ${fmt(Math.abs(W - U))} MT<br>
                            <strong>Price Movement:</strong> Warrant prices moved from $${fmt(pWi)} to $${fmt(pWj)} (${pWj > pWi ? '+' : ''}${fmt(pWj - pWi)})<br>
                            <strong>Net Result:</strong> ${traderTotal >= 0 ? 'Profitable' : 'Loss'} position of <strong>$${curr(Math.abs(traderTotal))}</strong>
                        </div>
                    </div>

                    <div class="result-card" style="border-left: 6px solid #ef4444; background: #fef2f2;">
                        <h3>üí∞ Carrying Costs (Information Only)</h3>
                        <div style="background: #fee2e2; padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                            <p style="color: #991b1b; margin-bottom: 0.5rem;"><strong>‚ÑπÔ∏è Note:</strong> These costs are shown for information only and are NOT included in the P&L calculation above.</p>
                        </div>
                        
                        <div style="background: #e0f2fe; padding: 0.8rem; border-radius: 8px; margin-bottom: 1rem; font-size: 0.9rem;">
                            <strong>üìÖ Day Count Calculation:</strong><br>
                            Pickup Date: ${pickupDate.toLocaleDateString('en-GB')} (${pickupDate.toLocaleDateString('en-US', {weekday: 'short', year: 'numeric', month: 'short', day: 'numeric'})})<br>
                            Delivery Date: ${deliveryDate.toLocaleDateString('en-GB')} (${deliveryDate.toLocaleDateString('en-US', {weekday: 'short', year: 'numeric', month: 'short', day: 'numeric'})})<br>
                            <strong>Days Between: ${autoDayCount} days</strong> (all calendar days including weekends)
                            ${rentDayCountOverride && rentDayCountOverride > 0 ? `<br><span style="color: #f59e0b;">‚ö†Ô∏è Rent day count overridden: ${rentDayCount} days</span>` : ''}
                            ${sofrDayCountOverride && sofrDayCountOverride > 0 ? `<br><span style="color: #f59e0b;">‚ö†Ô∏è SOFR day count overridden: ${sofrDayCount} days</span>` : ''}
                        </div>
                        
                        <div class="formula">
                            <strong>Rent Cost:</strong><br>
                            ${fmt(rentRate)} USD/MT/day √ó ${fmt(W)} MT √ó ${rentDayCount} days ${rentDayCountOverride && rentDayCountOverride > 0 ? '<span style="color: #f59e0b;">(manual override)</span>' : ''}<br>
                            = <strong style="color: #ef4444;">$${curr(rentCost)}</strong>
                        </div>

                        <div class="formula">
                            <strong>Fixed Fees:</strong><br>
                            $${fmt(fixedFeesPerLot)} per lot (Clearing: $${fmt(feesClearing)} + LME: $${fmt(feesLME)} + Macquarie: $${fmt(feesMacquarie)}) √ó ${Math.round(numLots)} lot${Math.round(numLots) !== 1 ? 's' : ''}<br>
                            = <strong style="color: #ef4444;">$${curr(totalFixedFees)}</strong>
                        </div>

                        <div class="formula">
                            <strong>Financing Cost (SOFR ${fmt(sofrRate)}%, ACT/360):</strong><br>
                            ${fmt(sofrRate)}% / 360 √ó ${sofrDayCount} days ${sofrDayCountOverride && sofrDayCountOverride > 0 ? '<span style="color: #f59e0b;">(manual override)</span>' : ''} √ó $${fmt(pWi)} √ó ${metalData.lotSize} MT √ó ${Math.round(numLots)} lot${Math.round(numLots) !== 1 ? 's' : ''}<br>
                            = <strong style="color: #ef4444;">$${curr(financingCost)}</strong>
                        </div>

                        <div style="background: #fee2e2; padding: 1rem; border-radius: 8px; margin-top: 1rem; border: 2px solid #ef4444;">
                            <strong style="font-size: 1.1rem;">Total Carrying Costs:</strong><br>
                            Rent ($${curr(rentCost)}) + Fees ($${curr(totalFixedFees)}) + Financing ($${curr(financingCost)})<br>
                            = <strong style="color: #991b1b; font-size: 1.2rem;">$${curr(totalCarryingCosts)}</strong>
                        </div>

                        <div style="background: #dbeafe; padding: 1rem; border-radius: 8px; margin-top: 1rem; border: 2px solid #3b82f6;">
                            <strong style="font-size: 1.1rem; color: #1e40af;">üí∞ Cash and Carry (Information Only):</strong><br>
                            <div style="margin-top: 0.5rem; font-size: 0.95rem;">
                                Future Spread: ($${fmt(pFj)} - $${fmt(pFi)}) √ó ${fmt(U)} MT = <strong>$${curr(spreadComponent)}</strong><br>
                                Total Carrying Costs: <strong>$${curr(totalCarryingCosts)}</strong><br>
                                <div style="border-top: 2px solid #3b82f6; margin-top: 0.5rem; padding-top: 0.5rem;">
                                    <strong style="font-size: 1.05rem;">Cash and Carry = Future Spread - Carrying Costs</strong><br>
                                    = <strong style="color: ${(spreadComponent - totalCarryingCosts) >= 0 ? '#059669' : '#dc2626'}; font-size: 1.2rem;">$${curr(spreadComponent - totalCarryingCosts)}</strong>
                                </div>
                            </div>
                        </div>

                        <div style="background: #fef3c7; padding: 1rem; border-radius: 8px; margin-top: 1rem;">
                            <strong>Net P&L After Carrying Costs:</strong><br>
                            Trading P&L ($${curr(traderTotal)}) + Carrying Costs ($${curr(totalCarryingCosts)})<br>
                            = <strong style="color: ${(traderTotal + totalCarryingCosts) >= 0 ? '#10b981' : '#ef4444'};">$${curr(traderTotal + totalCarryingCosts)}</strong>
                        </div>
                    </div>
                `;

                document.getElementById('resultsPanel').innerHTML = html;
            }, 500);
        }

        function exportToExcel() {
            // Get all input values
            const selectedMetal = document.getElementById('metalSelector').value;
            const metalData = METAL_PRICES[selectedMetal];
            const W = parseFloat(document.getElementById('weight').value.replace(/,/g, '.'));
            const U = parseFloat(document.getElementById('lotSize').value.replace(/,/g, '.'));
            const pFi = parseFloat(document.getElementById('pFi').value.replace(/,/g, '.'));
            const pWi = parseFloat(document.getElementById('pWi').value.replace(/,/g, '.'));
            const pFj = parseFloat(document.getElementById('pFj').value.replace(/,/g, '.'));
            const pWj = parseFloat(document.getElementById('pWj').value.replace(/,/g, '.'));
            const pickupDate = document.getElementById('pickupDate').value;
            const deliveryDate = document.getElementById('deliveryDate').value;
            
            // Carrying costs
            const rentRate = parseFloat(document.getElementById('rentRate').value.replace(/,/g, '.'));
            const sofrRate = parseFloat(document.getElementById('sofrRate').value.replace(/,/g, '.'));
            const feesClearing = parseFloat(document.getElementById('feesClearing').value.replace(/,/g, '.'));
            const feesLME = parseFloat(document.getElementById('feesLME').value.replace(/,/g, '.'));
            const feesMacquarie = parseFloat(document.getElementById('feesMacquarie').value.replace(/,/g, '.'));
            
            const wb = XLSX.utils.book_new();
            
            // Inputs Sheet
            const inputsData = [
                ['LME PHYSICAL WARRANT P&L CALCULATOR - INPUTS'],
                ['Metal: ' + metalData.name + ' (' + metalData.symbol + ')'],
                [],
                ['Parameter', 'Symbol', 'Value', 'Unit'],
                ['Physical Warrant Weight', 'W', W, 'MT'],
                ['Standard Lot Size', 'U', U, 'MT'],
                ['Weight Differential', 'W - U', W - U, 'MT'],
                [],
                ['PICKUP LEG', '', '', ''],
                ['Future Expiry/Pickup Date', '', pickupDate, ''],
                ['Future Purchase Price', 'P_Fi', pFi, 'USD/MT'],
                ['Warrant Pickup Price', 'P_wi', pWi, 'USD/MT'],
                ['Price Difference (Pickup)', 'P_wi - P_Fi', pWi - pFi, 'USD/MT'],
                [],
                ['DELIVERY LEG', '', '', ''],
                ['Future Expiry/Delivery Date', '', deliveryDate, ''],
                ['Future Price', 'P_Fj', pFj, 'USD/MT'],
                ['Warrant Delivery Price', 'P_wj', pWj, 'USD/MT'],
                ['Price Difference (Delivery)', 'P_wj - P_Fj', pWj - pFj, 'USD/MT'],
                ['Warrant Price Change', 'P_wj - P_wi', pWj - pWi, 'USD/MT'],
                ['Future Spread', 'P_Fj - P_Fi', pFj - pFi, 'USD/MT'],
                [],
                ['CARRYING COSTS', '', '', ''],
                ['Rent Rate', '', rentRate, 'USD/MT/day'],
                ['SOFR Rate', '', sofrRate, '%'],
                ['Clearing Fees', '', feesClearing, 'USD/lot'],
                ['LME Fees', '', feesLME, 'USD/lot'],
                ['Macquarie Fees', '', feesMacquarie, 'USD/lot']
            ];
            
            const wsInputs = XLSX.utils.aoa_to_sheet(inputsData);
            wsInputs['!cols'] = [{ wch: 30 }, { wch: 15 }, { wch: 15 }, { wch: 10 }];
            XLSX.utils.book_append_sheet(wb, wsInputs, 'Inputs');
            
            // Trader View Sheet
            const weightDiff = (pWj - pWi) * (W - U);
            const spreadPL = (pFj - pFi) * U;
            const pickupLegFuture = U * (pWi - pFi);
            const pickupLegTotal = pickupLegFuture;
            const deliveryLegSpread = spreadPL - pickupLegFuture;
            const deliveryLegTotal = weightDiff + deliveryLegSpread;
            const totalPL = pickupLegTotal + deliveryLegTotal;
            
            const traderData = [
                ['TRADER VIEW - P&L CALCULATION'],
                [],
                ['Component', 'Formula', 'Calculation', 'Result (USD)'],
                [],
                ['COMPONENT 1: Weight Differential P&L', '', '', ''],
                ['  P_wj - P_wi', '', pWj - pWi, ''],
                ['  W - U', '', W - U, ''],
                ['  Weight Diff P&L', '(P_wj - P_wi) √ó (W - U)', '', weightDiff],
                [],
                ['COMPONENT 2: Futures Spread P&L', '', '', ''],
                ['  P_Fj - P_Fi', '', pFj - pFi, ''],
                ['  U', '', U, ''],
                ['  Spread P&L', '(P_Fj - P_Fi) √ó U', '', spreadPL],
                [],
                ['LEG BREAKDOWN', '', '', ''],
                [],
                ['PICKUP LEG P&L', '', '', ''],
                ['  Future', 'U √ó (P_wi - P_Fi)', '', pickupLegFuture],
                ['  Warrant', '', '', 0],
                ['  Pickup Total', '', '', pickupLegTotal],
                [],
                ['DELIVERY LEG P&L', '', '', ''],
                ['  Weight Differential', '', '', weightDiff],
                ['  Spread (net of pickup)', '', '', deliveryLegSpread],
                ['  Delivery Total', '', '', deliveryLegTotal],
                [],
                ['TOTAL P&L', '', '', totalPL]
            ];
            
            const wsTrader = XLSX.utils.aoa_to_sheet(traderData);
            wsTrader['!cols'] = [{ wch: 30 }, { wch: 30 }, { wch: 20 }, { wch: 15 }];
            XLSX.utils.book_append_sheet(wb, wsTrader, 'Trader View');
            
            // M View Sheet
            const pickupFuturePL = U * (pWi - pFi);
            const deliveryFuturePL = U * (pFj - pWj);
            const pickupWarrantPL = W * (pWi - pWi);
            const deliveryWarrantPL = W * (pWj - pWj);
            const totalMPL = pickupFuturePL + deliveryFuturePL + pickupWarrantPL + deliveryWarrantPL;
            
            const murexData = [
                ['M VIEW - P&L CALCULATION'],
                [],
                ['Component', 'Formula', 'Calculation', 'Result (USD)'],
                [],
                ['PICKUP LEG', '', '', ''],
                ['  Future P&L', 'U √ó (P_wi - P_Fi)', '', pickupFuturePL],
                ['  Warrant P&L', 'W √ó (P_wi - P_wi)', '', pickupWarrantPL],
                ['  Pickup Total', '', '', pickupFuturePL + pickupWarrantPL],
                [],
                ['DELIVERY LEG', '', '', ''],
                ['  Future P&L', 'U √ó (P_Fj - P_wj)', '', deliveryFuturePL],
                ['  Warrant P&L', 'W √ó (P_wj - P_wj)', '', deliveryWarrantPL],
                ['  Delivery Total', '', '', deliveryFuturePL + deliveryWarrantPL],
                [],
                ['TOTAL P&L', '', '', totalMPL],
                [],
                ['NOTE: Trader View P&L = M View P&L', '', '', '']
            ];
            
            const wsMurex = XLSX.utils.aoa_to_sheet(murexData);
            wsMurex['!cols'] = [{ wch: 30 }, { wch: 30 }, { wch: 20 }, { wch: 15 }];
            XLSX.utils.book_append_sheet(wb, wsMurex, 'M View');
            
            const timestamp = new Date().toISOString().slice(0, 10);
            XLSX.writeFile(wb, `LME_${metalData.symbol}_PL_${timestamp}.xlsx`);
        }

        // Normalize number input (accept both comma and dot)
        function normalizeNumberInput(input) {
            if (!input) return input;
            const element = document.getElementById(input);
            if (element && element.value) {
                element.value = element.value.replace(/,/g, '.');
            }
        }

        // Update fees total
        function updateFeesTotal() {
            const clearing = parseFloat(document.getElementById('feesClearing').value.replace(/,/g, '.')) || 0;
            const lme = parseFloat(document.getElementById('feesLME').value.replace(/,/g, '.')) || 0;
            const macquarie = parseFloat(document.getElementById('feesMacquarie').value.replace(/,/g, '.')) || 0;
            const total = (clearing + lme + macquarie).toFixed(2);
            document.getElementById('feesTotal').textContent = total;
        }

        // Manual save with visual feedback
        function manualSaveData() {
            // Normalize all number inputs first
            const numberInputs = ['weight', 'lotSize', 'pFi', 'pWi', 'pFj', 'pWj', 'rentRate', 'sofrRate', 
                                 'feesClearing', 'feesLME', 'feesMacquarie'];
            numberInputs.forEach(id => normalizeNumberInput(id));
            
            // Save data
            saveFormData();
            
            // Visual feedback
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = '‚úÖ Saved!';
            btn.style.background = 'linear-gradient(135deg, #059669 0%, #047857 100%)';
            
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.style.background = 'linear-gradient(135deg, #10b981 0%, #059669 100%)';
            }, 2000);
        }

        // Save data to localStorage
        function saveFormData() {
            const formData = {
                metalSelector: document.getElementById('metalSelector').value,
                weight: document.getElementById('weight').value,
                lotSize: document.getElementById('lotSize').value,
                pickupDate: document.getElementById('pickupDate').value,
                deliveryDate: document.getElementById('deliveryDate').value,
                pFi: document.getElementById('pFi').value,
                pWi: document.getElementById('pWi').value,
                pFj: document.getElementById('pFj').value,
                pWj: document.getElementById('pWj').value,
                rentRate: document.getElementById('rentRate').value,
                sofrRate: document.getElementById('sofrRate').value,
                feesClearing: document.getElementById('feesClearing').value,
                feesLME: document.getElementById('feesLME').value,
                feesMacquarie: document.getElementById('feesMacquarie').value,
                rentDayCountOverride: document.getElementById('rentDayCountOverride').value,
                dayCountOverride: document.getElementById('dayCountOverride').value
            };
            localStorage.setItem('lme_calculator_data', JSON.stringify(formData));
        }

        // Load data from localStorage
        function loadFormData() {
            const savedData = localStorage.getItem('lme_calculator_data');
            if (savedData) {
                try {
                    const formData = JSON.parse(savedData);
                    
                    if (formData.metalSelector) document.getElementById('metalSelector').value = formData.metalSelector;
                    if (formData.weight) document.getElementById('weight').value = formData.weight;
                    if (formData.lotSize) document.getElementById('lotSize').value = formData.lotSize;
                    if (formData.pickupDate) document.getElementById('pickupDate').value = formData.pickupDate;
                    if (formData.deliveryDate) document.getElementById('deliveryDate').value = formData.deliveryDate;
                    if (formData.pFi) document.getElementById('pFi').value = formData.pFi;
                    if (formData.pWi) document.getElementById('pWi').value = formData.pWi;
                    if (formData.pFj) document.getElementById('pFj').value = formData.pFj;
                    if (formData.pWj) document.getElementById('pWj').value = formData.pWj;
                    if (formData.rentRate) document.getElementById('rentRate').value = formData.rentRate;
                    if (formData.sofrRate) document.getElementById('sofrRate').value = formData.sofrRate;
                    if (formData.feesClearing) document.getElementById('feesClearing').value = formData.feesClearing;
                    if (formData.feesLME) document.getElementById('feesLME').value = formData.feesLME;
                    if (formData.feesMacquarie) document.getElementById('feesMacquarie').value = formData.feesMacquarie;
                    if (formData.rentDayCountOverride) document.getElementById('rentDayCountOverride').value = formData.rentDayCountOverride;
                    if (formData.dayCountOverride) document.getElementById('dayCountOverride').value = formData.dayCountOverride;
                    
                    // Update metal prices and fees total after loading
                    updateMetalPrices();
                    updateFeesTotal();
                } catch (e) {
                    console.error('Error loading saved data:', e);
                }
            }
        }

        // Clear saved data
        function clearSavedData() {
            if (confirm('Are you sure you want to clear all saved data?')) {
                localStorage.removeItem('lme_calculator_data');
                alert('‚úÖ Saved data cleared successfully!');
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            updateMarketStatus();
            setInterval(updateMarketStatus, 60000);
            updateMetalPrices();
            
            // Load saved data
            loadFormData();
            
            // Auto-normalize comma to dot on blur (when leaving the field)
            const numberInputs = ['weight', 'lotSize', 'pFi', 'pWi', 'pFj', 'pWj', 'rentRate', 'sofrRate', 
                                 'feesClearing', 'feesLME', 'feesMacquarie'];
            numberInputs.forEach(id => {
                const element = document.getElementById(id);
                element.addEventListener('blur', function() {
                    if (this.value) {
                        this.value = this.value.replace(/,/g, '.');
                        saveFormData(); // Save after normalization
                    }
                });
            });
            
            // Save data on input change
            const allInputs = ['metalSelector', 'weight', 'lotSize', 'pickupDate', 'deliveryDate', 
                              'pFi', 'pWi', 'pFj', 'pWj', 'rentRate', 'sofrRate', 
                              'feesClearing', 'feesLME', 'feesMacquarie', 'rentDayCountOverride', 'dayCountOverride'];
            allInputs.forEach(id => {
                const element = document.getElementById(id);
                element.addEventListener('input', saveFormData);
                element.addEventListener('change', saveFormData);
            });
            
            // Update fees total on change
            ['feesClearing', 'feesLME', 'feesMacquarie'].forEach(id => {
                document.getElementById(id).addEventListener('input', updateFeesTotal);
                document.getElementById(id).addEventListener('blur', updateFeesTotal);
            });
            
            // Add real-time calculation on input change
            const inputs = ['weight', 'pFi', 'pWi', 'pFj', 'pWj'];
            inputs.forEach(id => {
                document.getElementById(id).addEventListener('input', function() {
                    if (document.querySelector('.result-card')) {
                        calculate();
                    }
                });
            });
            
            // Initial validation of dates
            const dateInputs = ['pickupPurchaseDate', 'pickupDate', 'deliveryPurchaseDate', 'deliveryDate'];
            dateInputs.forEach(id => {
                validateDate(document.getElementById(id));
            });
        });
    </script>
</body>
</html>
